<!DOCTYPE html>
<html>
<head>
    <title>Flexible-World: Civilization</title>
    <style>
        body { 
            margin: 0; background-color: #111; color: #fff; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; overflow: hidden; font-family: 'Courier New', monospace;
            user-select: none;
        }
        
        /* UI ë ˆì´ì–´ */
        #ui-layer { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 10; text-align: left; }
        h2 { margin: 0; text-shadow: 2px 2px 0 #000; font-size: 20px; }
        p { margin: 2px 0; font-size: 14px; color: #ccc; text-shadow: 1px 1px 0 #000; }
        
        /* í˜„ì¬ ì„ íƒëœ ì¬ë£Œ í‘œì‹œ */
        #material-indicator {
            margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.6); 
            border: 2px solid #fff; display: inline-block;
        }

        /* ì±„íŒ…ì°½ */
        #chat-container { position: absolute; bottom: 20px; width: 100%; text-align: center; pointer-events: none; z-index: 10; }
        #chat-input { 
            pointer-events: auto; background: rgba(0,0,0,0.7); border: 1px solid #555; color: white; 
            padding: 10px; width: 300px; border-radius: 20px; outline: none; text-align: center;
        }
        
        /* [V4] ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #login-box {
            background: #222; padding: 40px; border: 2px solid #555; text-align: center; border-radius: 10px;
        }
        #nickname-input {
            padding: 10px; font-size: 16px; width: 200px; text-align: center;
            background: #333; border: 1px solid #666; color: white; margin-bottom: 20px;
        }
        #start-btn {
            padding: 10px 30px; font-size: 18px; cursor: pointer;
            background: #4CAF50; color: white; border: none; border-radius: 5px;
        }
        #start-btn:hover { background: #45a049; }

        canvas { border: 1px solid #444; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="firebaseConfig.js"></script>
</head>
<body>

    <div id="login-screen">
        <div id="login-box">
            <h1>FLEXIBLE-WORLD</h1>
            <p>ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì•Œë ¤ì£¼ì„¸ìš”</p>
            <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 6ê¸€ì)" maxlength="6">
            <br>
            <button id="start-btn">ì„¸ìƒì— ë˜ì ¸ì§€ê¸° (Enter)</button>
        </div>
    </div>

    <div id="ui-layer">
        <h2>BUILDER MODE</h2>
        <div id="material-indicator">í˜„ì¬ ì¬ë£Œ: ğŸ”² ëŒë²½ (1)</div>
        <p>1,2,3: ì¬ë£Œ ë³€ê²½ | í´ë¦­: ê±´ì„¤ | Shift+í´ë¦­: íŒŒê´´</p>
        <div id="status" style="color: yellow;">ëŒ€ê¸° ì¤‘...</div>
    </div>

    <div id="game-container"></div>

    <div id="chat-container">
        <input type="text" id="chat-input" placeholder="ëŒ€í™” ì…ë ¥ (Enter)" maxlength="30">
    </div>

    <script>
        // 0. ì•ˆì „ì¥ì¹˜
        if (typeof firebaseConfig === 'undefined') {
            alert("ì„¤ì • íŒŒì¼ ì˜¤ë¥˜! firebaseConfig.jsë¥¼ í™•ì¸í•˜ì„¸ìš”."); throw new Error("Config missing");
        }

        // 1. íŒŒì´ì–´ë² ì´ìŠ¤ & ì „ì—­ ë³€ìˆ˜
        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const db = firebase.database();
        
        let myId;
        let myNickname = "ìµëª…";
        let myColor;
        
        // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
        let currentMaterial = 'wall'; // ê¸°ë³¸ ì¬ë£Œ
        let isGameStarted = false;

        // Phaser ë³€ìˆ˜
        let game;
        let myPlayer;
        let cursors;
        let shiftKey;
        let key1, key2, key3; // ì¬ë£Œ ë³€ê²½ í‚¤
        
        let players = {};
        let playerTexts = {};
        let blocks = {};
        let marker;
        
        // ê·¸ë£¹ (ë ˆì´ì–´ ê´€ë¦¬ìš©)
        let floorGroup; // ë°”ë‹¥ (ë°Ÿì„ ìˆ˜ ìˆìŒ)
        let wallGroup;  // ë²½ (ëª» ì§€ë‚˜ê°)

        // ==========================================
        // [V4] ë¡œê·¸ì¸ ë¡œì§
        // ==========================================
        const loginScreen = document.getElementById('login-screen');
        const nickInput = document.getElementById('nickname-input');
        const startBtn = document.getElementById('start-btn');

        function startGame() {
            const name = nickInput.value.trim();
            if (name === "") { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
            
            myNickname = name;
            myId = 'user_' + Math.floor(Math.random() * 1000000);
            // ëœë¤ ìƒ‰ìƒ ìƒì„± (ë„ˆë¬´ ì–´ë‘ìš´ ìƒ‰ ì œì™¸)
            myColor = Phaser.Display.Color.RandomRGB(50, 255).color; 

            loginScreen.style.display = 'none'; // ë¡œê·¸ì¸ì°½ ìˆ¨ê¹€
            isGameStarted = true;
            
            // ê²Œì„ ì‹œì‘
            game = new Phaser.Game(config);
        }

        startBtn.addEventListener('click', startGame);
        nickInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') startGame(); });


        // ==========================================
        // Phaser ê²Œì„ ì„¤ì •
        // ==========================================
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            backgroundColor: '#2d2d2d',
            physics: { default: 'arcade', arcade: { debug: false } },
            disableContextMenu: true,
            scene: { preload: preload, create: create, update: update }
        };

        function preload() {
            this.load.image('dude', 'https://labs.phaser.io/assets/sprites/phaser-dude.png');
            
            // [V5] í…ìŠ¤ì²˜ ì¦‰ì„ ìƒì„± (ì´ë¯¸ì§€ íŒŒì¼ ì—†ì´ ì½”ë“œë¡œ ë§Œë“¦)
            // 1. ëŒë²½ (íšŒìƒ‰)
            let g = this.make.graphics({x:0, y:0});
            g.fillStyle(0x888888); g.fillRect(0,0,32,32);
            g.lineStyle(2, 0x555555); g.strokeRect(0,0,32,32); // í…Œë‘ë¦¬
            g.generateTexture('wall', 32, 32);

            // 2. ì”ë”” (ì´ˆë¡)
            g.clear();
            g.fillStyle(0x4CAF50); g.fillRect(0,0,32,32);
            g.fillStyle(0x388E3C); g.fillCircle(10,10,2); g.fillCircle(25,25,3); // ë¬´ëŠ¬
            g.generateTexture('grass', 32, 32);

            // 3. ë¬¼ (íŒŒë‘)
            g.clear();
            g.fillStyle(0x2196F3); g.fillRect(0,0,32,32);
            g.generateTexture('water', 32, 32);
        }

        function create() {
            const self = this;
            
            // ì—°ê²° ìƒíƒœ í‘œì‹œ
            db.ref(".info/connected").on("value", (snap) => {
                const status = document.getElementById('status');
                if (snap.val()) { status.innerText = "ì—°ê²°ë¨"; status.style.color = "#00ff00"; }
                else { status.innerText = "ëŠê¹€"; status.style.color = "red"; }
            });

            this.input.mouse.disableContextMenu();

            // [ë ˆì´ì–´ ìˆœì„œ ì¤‘ìš”] ë°”ë‹¥ -> ë²½ -> í”Œë ˆì´ì–´
            floorGroup = this.add.group();      // ë¬¼ë¦¬ ì ìš© X (ê·¸ëƒ¥ ê·¸ë¦¼)
            wallGroup = this.physics.add.staticGroup(); // ë¬¼ë¦¬ ì ìš© O (ì¶©ëŒ)

            // ë‚˜ ìì‹  ìƒì„±
            const startX = Math.floor(Math.random() * 20) * 32 + 16;
            const startY = Math.floor(Math.random() * 15) * 32 + 16;
            myPlayer = this.physics.add.sprite(startX, startY, 'dude');
            myPlayer.setTint(myColor); // [V4] ë‚´ ìƒ‰ìƒ ì ìš©
            myPlayer.setCollideWorldBounds(true);
            
            // ë‚´ ë‹‰ë„¤ì„ í‘œì‹œ
            this.myText = this.add.text(startX, startY - 25, myNickname, {
                fontSize: '12px', fill: '#fff', backgroundColor: '#00000088', padding: {x:4, y:2}
            }).setOrigin(0.5);

            // ì¶©ëŒ ì„¤ì • (í”Œë ˆì´ì–´ëŠ” ë²½í•˜ê³ ë§Œ ë¶€ë”ªí˜)
            this.physics.add.collider(myPlayer, wallGroup);

            // ë§ˆìš°ìŠ¤ ì»¤ì„œ
            marker = this.add.graphics();
            marker.lineStyle(2, 0xffffff, 1);
            marker.strokeRect(0, 0, 32, 32);

            // í‚¤ë³´ë“œ ì…ë ¥
            cursors = this.input.keyboard.createCursorKeys();
            shiftKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT);
            
            // [V5] ì¬ë£Œ ë³€ê²½ í‚¤
            key1 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ONE);
            key2 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.TWO);
            key3 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.THREE);

            // ë‚´ ì •ë³´ DB ë“±ë¡ (ìƒ‰ìƒ, ë‹‰ë„¤ì„ í¬í•¨)
            db.ref('players/' + myId).set({
                x: startX, y: startY,
                nickname: myNickname,
                color: myColor
            });

            // ==========================================
            // ê±´ì„¤ ì‹œìŠ¤í…œ (ì¬ë£Œ ë°˜ì˜)
            // ==========================================
            this.input.on('pointerdown', (pointer) => {
                if (pointer.event.target.id === 'chat-input') return;

                const gridX = Math.floor(pointer.worldX / 32) * 32 + 16;
                const gridY = Math.floor(pointer.worldY / 32) * 32 + 16;
                const blockKey = `${gridX}_${gridY}`;

                if (pointer.event.shiftKey) {
                    db.ref('blocks/' + blockKey).remove(); // íŒŒê´´
                } else {
                    // [V5] í˜„ì¬ ì„ íƒëœ ì¬ë£Œíƒ€ì…(currentMaterial)ì„ í•¨ê»˜ ì €ì¥
                    db.ref('blocks/' + blockKey).set({ 
                        x: gridX, y: gridY, 
                        type: currentMaterial 
                    });
                }
            });

            // ì±„íŒ… ì…ë ¥
            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('keydown', (e) => {
                e.stopPropagation();
                if (e.key === 'Enter' && chatInput.value.trim() !== "") {
                    const msg = chatInput.value;
                    chatInput.value = "";
                    db.ref('players/' + myId).update({ chat: msg, chatTime: firebase.database.ServerValue.TIMESTAMP });
                    showChatBubble(self.myText, msg, myNickname);
                    game.canvas.focus();
                }
            });

            // ================= ë°ì´í„° ë™ê¸°í™” =================

            // 1. ë‚´ ìœ„ì¹˜
            this.time.addEvent({
                delay: 50, loop: true,
                callback: () => {
                    if (myPlayer.body.velocity.x !== 0 || myPlayer.body.velocity.y !== 0) {
                        db.ref('players/' + myId).update({ x: myPlayer.x, y: myPlayer.y });
                    }
                    self.myText.x = myPlayer.x;
                    self.myText.y = myPlayer.y - 25;
                }
            });

            // 2. ë‹¤ë¥¸ í”Œë ˆì´ì–´
            db.ref('players').on('child_added', (snapshot) => handlePlayerUpdate(snapshot, self, 'add'));
            db.ref('players').on('child_changed', (snapshot) => handlePlayerUpdate(snapshot, self, 'change'));
            db.ref('players').on('child_removed', (snapshot) => {
                const id = snapshot.key;
                if (players[id]) players[id].destroy();
                if (playerTexts[id]) playerTexts[id].destroy();
            });

            // 3. [V5] ë¸”ë¡ ë™ê¸°í™” (ì¬ë£Œ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ê·¸ë¦¬ê¸°)
            db.ref('blocks').on('child_added', (snapshot) => {
                createBlock(self, snapshot.key, snapshot.val());
            });
            db.ref('blocks').on('child_changed', (snapshot) => {
                // íƒ€ì…ì´ ë°”ë€Œì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì§€ìš°ê³  ë‹¤ì‹œ ìƒì„±
                removeBlock(snapshot.key);
                createBlock(self, snapshot.key, snapshot.val());
            });
            db.ref('blocks').on('child_removed', (snapshot) => {
                removeBlock(snapshot.key);
            });

            db.ref('players/' + myId).onDisconnect().remove();
        }

        function update() {
            if (!myPlayer) return;

            // [V5] ì¬ë£Œ ë³€ê²½ ê°ì§€
            const uiText = document.getElementById('material-indicator');
            if (Phaser.Input.Keyboard.JustDown(key1)) { currentMaterial = 'wall'; uiText.innerText = "í˜„ì¬ ì¬ë£Œ: ğŸ”² ëŒë²½ (1)"; }
            if (Phaser.Input.Keyboard.JustDown(key2)) { currentMaterial = 'grass'; uiText.innerText = "í˜„ì¬ ì¬ë£Œ: ğŸŒ¿ ì”ë”” (2)"; }
            if (Phaser.Input.Keyboard.JustDown(key3)) { currentMaterial = 'water'; uiText.innerText = "í˜„ì¬ ì¬ë£Œ: ğŸ’§ ë¬¼ (3)"; }

            // ì»¤ì„œ ì—…ë°ì´íŠ¸
            const pointer = this.input.activePointer;
            marker.x = Math.floor(pointer.worldX / 32) * 32;
            marker.y = Math.floor(pointer.worldY / 32) * 32;

            if (shiftKey.isDown) marker.lineStyle(2, 0xff0000, 1);
            else marker.lineStyle(2, 0xffffff, 1);

            // ì´ë™
            const speed = 160;
            myPlayer.setVelocity(0);
            if (document.activeElement !== document.getElementById('chat-input')) {
                if (cursors.left.isDown) myPlayer.setVelocityX(-speed);
                else if (cursors.right.isDown) myPlayer.setVelocityX(speed);
                if (cursors.up.isDown) myPlayer.setVelocityY(-speed);
                else if (cursors.down.isDown) myPlayer.setVelocityY(speed);
            }
        }

        // ================= ë³´ì¡° í•¨ìˆ˜ë“¤ =================

        function createBlock(scene, key, data) {
            // ì´ë¯¸ ìˆìœ¼ë©´ ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
            removeBlock(key);

            let block;
            if (data.type === 'wall' || !data.type) { // ê¸°ë³¸ê°’ì€ wall
                block = wallGroup.create(data.x, data.y, 'wall');
                block.refreshBody(); // ì¶©ëŒì²´ ê°±ì‹ 
            } else if (data.type === 'grass') {
                block = floorGroup.create(data.x, data.y, 'grass');
            } else if (data.type === 'water') {
                block = floorGroup.create(data.x, data.y, 'water');
            }
            blocks[key] = block;
        }

        function removeBlock(key) {
            if (blocks[key]) {
                blocks[key].destroy();
                delete blocks[key];
            }
        }

        function handlePlayerUpdate(snapshot, scene, type) {
            const id = snapshot.key;
            if (id === myId) return;
            const data = snapshot.val();
            
            if (!players[id]) {
                // [V4] ì ‘ì† ì‹œ íƒ€ì¸ì˜ ë‹‰ë„¤ì„ê³¼ ìƒ‰ìƒ ë°˜ì˜
                players[id] = scene.add.sprite(data.x, data.y, 'dude');
                players[id].setTint(data.color || 0xffffff); // ìƒ‰ìƒ ì—†ìœ¼ë©´ í°ìƒ‰
                
                playerTexts[id] = scene.add.text(data.x, data.y - 25, data.nickname || "ìµëª…", { 
                    fontSize: '12px', fill: '#fff', backgroundColor: '#00000088' 
                }).setOrigin(0.5);
            } else {
                players[id].x = data.x;
                players[id].y = data.y;
                playerTexts[id].x = data.x;
                playerTexts[id].y = data.y - 25;
            }
            if (data.chat && (type === 'change' || type === 'add')) {
                showChatBubble(playerTexts[id], data.chat, data.nickname);
            }
        }

        function showChatBubble(textObj, msg, originalName) {
            if (!textObj) return;
            textObj.setText(msg);
            textObj.setStyle({ backgroundColor: '#ffffff', fill: '#000' });
            setTimeout(() => {
                if (textObj && textObj.scene) {
                    textObj.setText(originalName); // ì›ë˜ ì´ë¦„ìœ¼ë¡œ ë³µê·€
                    textObj.setStyle({ backgroundColor: '#00000088', fill: '#fff' });
                }
            }, 3000);
        }
    </script>
</body>
</html>